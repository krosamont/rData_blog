<!DOCTYPE html>
<html class="no-js">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Scraping data from the local elections  &middot; rData.lu - Specialized in data science training and expertise</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="Web scraping consists in extracting data from websites. Here we will scrape results from the Luxembourg local elections 2017." />

<meta name="keywords" content="Election, web data, ">


<meta property="og:title" content="Scraping data from the local elections  &middot; rData.lu - Specialized in data science training and expertise ">
<meta property="og:site_name" content="rData.lu - Specialized in data science training and expertise"/>
<meta property="og:url" content="/post/2017-10-27-scraping-data-from-the-local-elections/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="article" />
<meta property="og:description" content="Web scraping consists in extracting data from websites. Here we will scrape results from the Luxembourg local elections 2017."/>
<meta property="og:article:published_time" content="2017-10-27T06:34:55&#43;02:00" />
<meta property="og:article:modified_time" content="2017-10-27T06:34:55&#43;02:00" />

  
    
<meta property="og:article:tag" content="Election">
    
<meta property="og:article:tag" content="web data">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="Scraping data from the local elections" />
<meta name="twitter:description" content="Web scraping consists in extracting data from websites. Here we will scrape results from the Luxembourg local elections 2017." />
<meta name="twitter:url" content="/post/2017-10-27-scraping-data-from-the-local-elections/" />
<meta name="twitter:domain" content="/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Scraping data from the local elections",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2017-10-27",
    "description": "Web scraping consists in extracting data from websites. Here we will scrape results from the Luxembourg local elections 2017.",
    "wordCount": 1126
  }
</script>



<link rel="canonical" href="/post/2017-10-27-scraping-data-from-the-local-elections/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
<link href="/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.29" />

  <meta name="description" content="The purpose of this blog is to share our R knowledge with some tips that have been useful for our own data analysis. Most posts use public
  data that have been scraped using R or Python." />
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/css/font-awesome.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/tomorrow-night.css">
  <link href='//fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>

</head>
<body class="bg-light">
    <link href="https://fonts.googleapis.com/css?family=Quicksand:300,400,500,700" rel="stylesheet">
<link rel="shortcut icon" href="/img/favicon.png">
<nav class="navbar navbar-expand-md navbar-light blog-header">
  <div class="container contt">
    <a class="navbar-brand" href="http://www.rdata.lu/"><span class="red">r</span>Data<span class="blue">.lu</span> 
      
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse"
        data-target="#exCollapsingNavbar2"
        aria-controls="exCollapsingNavbar2" aria-expanded="false" aria-label="Toggle navigation">
      &#9776;
    </button>
    <div class="collapse navbar-collapse" id="exCollapsingNavbar2">

      <ul class="nav navbar-nav">

        <li class="pull-xs-right">
        
        
          <li class="nav-item ">
          <a class="nav-link menu-item" href="/">
              <i class='fa fa-home'></i>
              <span>HOME</span>
          </a>
        </li>

        
          <li class="nav-item ">
          <a class="nav-link menu-item" href="/page/visualization">
              <i class='fa fa-pie-chart'></i>
              <span>VISUALIZATION</span>
          </a>
        </li>

        
          <li class="nav-item ">
          <a class="nav-link menu-item" href="/categories/">
              <i class='fa fa-folder-open'></i>
              <span>CATEGORIES</span>
          </a>
        </li>

        
          <li class="nav-item ">
          <a class="nav-link menu-item" href="/page/contact">
              <i class='fa fa-info-circle'></i>
              <span>CONTACT</span>
          </a>
        </li>

        
        </li>
      </ul>
    </div>
  </div>
</nav>


<div class="container p-a-0 large">
  <div class="row m-l-0 m-r-0">
    <div class="col-xs-12 col-md-12 post-container">
      <div>
  
<a href="/post/2017-10-27-scraping-data-from-the-local-elections/" itemprop="url">
    
      <img src="/images/results.svg" class="img-fluid" alt="Generic responsive image">
    
</a>

<div class="container">
    <div class="row">
        <div class="col-12 name" >
    <img id="avatar" src="images/logo.png" />
    
       by Kevin Rosamont
    
        </div>
        
    </div>
    </div>

  <div class="container">
    <div class="col-xs-12 col-sm-12 col-md-10 col-lg-10">
      <h1 class="post-title cat" >Scraping data from the local elections
</h1>
    </div>
  </div>

  <div class="container">
    <div class="col-xs-12 col-sm-12 col-md-10 col-lg-10">
      <div class="post-meta">
      <div class="post-meta-item">
        <i class="fa fa-calendar"></i>
        <time datetime="2017-10-27">27 Oct, 2017</time>
      </div>
      <div class="row itemHome">
        
            
            
            <div class="post-meta-item">
                <i class="fa fa-folder-open-o"></i>
                
                <a class="article-category-link" href="/categories/scrapping">Scrapping</a>
                
                
            </div>
            
        

        
            
            
              <div class="post-meta-item">
                <i class="fa fa-tags"></i>
                
                <a href="/tags/election/">Election</a>
                &middot;
                
                <a href="/tags/web-data/">web data</a>
                
                
              </div>
            
        

      </div>



      <div class="row itemHome">
         6 Minute Read
         1126 Words
        
        <div class="post-meta-item">
          &nbsp;<i class="fa fa-comment-o"></i>
          <a href="/post/2017-10-27-scraping-data-from-the-local-elections/#disqus_thread" class="article-comment-link">
               Comments
          </a>
        </div>
        

      </div>


    </div>
    </div>
  </div>

</div>

      <div class="content">
  <div class="container">
    <div class="col-xs-12 col-sm-12 col-md-10 col-lg-10">
      <p>One of my journalist friend was looking at the result of the local election in Luxembourg and he was dissatisfied because he was unable to compare the results of all the communes. In fact, he wanted to compare the number of women that were candidates in each commune. So I asked him to hold on and I came back one hour later with this script that enables him to collect results of all communes in one table.</p>
<p>At the beginning, it was private code but I thought that it could be another great scraping example after the excellent post written by my colleague Bruno Rodrigues about scraping data from STATEC public tables.</p>
<p>So let’s get started. First, let’s load some packages:</p>
<pre class="r"><code>#we have to load the packages if they are not installed on your computer,
#begin with the commented following lines:
#install.packages( &quot;rvest&quot; )
#install.packages( &quot;tidyverse&quot; )
#install.packages( &quot;stringr&quot; )

library(rvest) #to scrap
library(dplyr) #to manipulate data
library(stringr) #to manipulate string</code></pre>
<p>We want to collect results of all communes in one data frame. We go to <a href="http://www.elections.public.lu" class="uri">http://www.elections.public.lu</a> and we collect data that is seen in the GIF bellow:</p>
<p>After clicking on different communes, we notice that the URLs have the same format. They have 3 parts :<br> 1: “<a href="http://www.elections.public.lu/fr/elections-communales/2017/resultats/communes/" class="uri">http://www.elections.public.lu/fr/elections-communales/2017/resultats/communes/</a>”, the first part of the URL.<br> 2: “communes_names” the name of the city is the second part of the URL.<br> 3: “.html” is the last part.<br></p>
<p>For example, the complete URL for the commune of Luxembourg will be: <a href="http://www.elections.public.lu/fr/elections-communales/2017/resultats/communes/luxembourg.html" class="uri">http://www.elections.public.lu/fr/elections-communales/2017/resultats/communes/luxembourg.html</a><br><br></p>
<p>There are 103 communes, so we have to put all of them in a list. We scrape the 103 communes in one list via the script bellow :</p>
<pre class="r"><code>url = &quot;http://www.elections.public.lu/fr/elections-communales/2017/resultats/communes/bech.html&quot;
communes = read_html(url) %&gt;% 
        html_nodes(&quot;#communes #communes-az li&quot;) %&gt;%
        html_text() </code></pre>
<p>We verify that we have a list of 103 vectors and then we check the 5 first rows.</p>
<pre class="r"><code>length(communes)</code></pre>
<pre><code>## [1] 103</code></pre>
<pre class="r"><code>head(communes,5)</code></pre>
<pre><code>## [1] &quot;\r\n        Beaufort\r\n                a rendu l&#39;ensemble de ses résultats\r\n    &quot; 
## [2] &quot;\r\n        Bech\r\n                a rendu l&#39;ensemble de ses résultats\r\n    &quot;     
## [3] &quot;\r\n        Beckerich\r\n                a rendu l&#39;ensemble de ses résultats\r\n    &quot;
## [4] &quot;\r\n        Berdorf\r\n                a rendu l&#39;ensemble de ses résultats\r\n    &quot;  
## [5] &quot;\r\n        Bertrange\r\n                a rendu l&#39;ensemble de ses résultats\r\n    &quot;</code></pre>
<p>It seems that the 103 communes are present but we still have to clean the data.</p>
<pre class="r"><code>#Data is not cleaned and there are some useless characters that need to be removed.
#We need to clean data.
communes = gsub(&quot;a rendu l&#39;ensemble de ses résultats&quot;,&quot; &quot;, communes )
communes = trimws(gsub(&quot;\r\n&quot;,&quot;&quot;,communes ))
communes = gsub(&quot;/Attert&quot;,&quot;-sur-attert&quot;, communes )
communes = gsub(&quot; - &quot;, &quot;-&quot;,communes )
communes = gsub(&quot; &quot;, &quot;-&quot;,communes )
communes = gsub(&quot;&#39;&quot;, &quot;-&quot;,communes )
communes = gsub(&quot;é&quot;, &quot;e&quot;,communes )
communes = gsub(&quot;û&quot;, &quot;u&quot;,communes )
communes = gsub(&quot;ä&quot;, &quot;a&quot;,communes )

#Lower case
communes = tolower(communes)

head(communes, 5)</code></pre>
<pre><code>## [1] &quot;beaufort&quot;  &quot;bech&quot;      &quot;beckerich&quot; &quot;berdorf&quot;   &quot;bertrange&quot;</code></pre>
<p>Now that we have the list of the 103 communes, we will write a function that will enable us to collect data that we want to display in our data frame.</p>
<pre class="r"><code>#Function to have the result for one commune.
  result = function(x){
  #scrapping data
  vote = read_html(paste(&quot;http://www.elections.public.lu/fr/elections-communales/2017/resultats/communes/&quot;,x,&quot;.html&quot;, sep=&quot;&quot;)) %&gt;% 
          html_nodes(&quot;#lux-number .lux-number ul li&quot;) %&gt;%
          html_text()%&gt;%.[-1]
  
  #Conditions need to be added to have clean data.
  #Here we add a trick, the vector 14 and 15 are the only ones that   haven&#39;t the string &quot;\r\n&quot;.
  #So we add &quot;\r\n&quot; to these vectors.
  if(nchar(vote[14]) &gt; 21){
          vote[14] = gsub(&quot;ble&quot;,&quot;ble\r\n&quot;, vote[14],perl = FALSE)
  }
  if(nchar(vote[15]) &gt; 21){
          vote[15] = gsub(&quot;mé&quot;,&quot;mé\r\n&quot;, vote[15],perl = FALSE)
  }
  #We split vectors to dissociate the results (numbers) and the titles   (letters).
  vote = unlist(str_split(vote, &quot;\r\n&quot;))
  vote = trimws(vote)
  vote = vote[vote != &quot;&quot;]
  
  #Here we have similar title so we change them to not be confused.
  #Candidat Lux means Luxemburgish Candidates  &amp; Electeur Lux means   Luxemburgish voters. 
  vote[7] = gsub(&quot;Lux&quot;, &quot;Candidat Lux&quot;, vote[7] )
  vote[9] = gsub(&quot;Non Lu&quot;, &quot;Candidat Non Lu&quot;, vote[9] )
  vote[13] = gsub(&quot;Lux&quot;, &quot;Electeur Lux&quot;, vote[13] )
  vote[15] = gsub(&quot;Non Lu&quot;, &quot;Electeur Non Lu&quot;, vote[15]  )
  
  #We create the data frame.
  #Vector with pair indice value are the results (the column val).
  pair = (1:15)*2
  
  #Vectors with odd index value are the titles (the column title).
  impair = (1:15)*2 - 1
  res = data.frame(communes = rep(x,15), title = vote[impair], val =   vote[pair])
  return(res)
}</code></pre>
<p>Then we use the lapply() function to apply this function to the 103 communes and bind them in one data frame:</p>
<pre class="r"><code>#We use the result function on all the communes.
res = lapply(communes, result)
#We bind the rows to have a complete data frame with all the results from all communes
#then we bind all the result.
df = do.call(rbind, res)</code></pre>
<p>To see the 5 first rows of our new data frame:</p>
<pre class="r"><code>#Now the data that we have look like this:
head(df,5)</code></pre>
<pre><code>##   communes                       title val
## 1 beaufort                       Total  10
## 2 beaufort                      Femmes   5
## 3 beaufort                      Hommes   5
## 4 beaufort     Candidat Luxembourgeois  10
## 5 beaufort Candidat Non Luxembourgeois   0</code></pre>
<p>As you can see, it’s looking good but we are not completely satisfied because we would like to transpose data to have one result in one column. To this end, we use the <code>tidyr</code> package.</p>
<pre class="r"><code>library(tidyr)

#Transposing data will enables us to make analysis faster.
#We transform val in a numeric variable then we transpose data.

tdf = df %&gt;%
        mutate(val = as.numeric(gsub(&quot; &quot;, &quot;&quot;, val))) %&gt;%
        spread(title, val)</code></pre>
<p>To see the 5 first rows of our new data frame:</p>
<pre class="r"><code>#Now the data that we have look like this:
head(tdf,5)</code></pre>
<pre><code>##    communes Blancs Candidat Luxembourgeois Candidat Non Luxembourgeois
## 1  beaufort     78                      10                           0
## 2      bech      0                       8                           0
## 3 beckerich     67                      10                           1
## 4   berdorf     23                      20                           0
## 5 bertrange     75                      45                           7
##   Dans l&#39;urne Electeur Luxembourgeois Electeur Non Luxembourgeois Femmes
## 1        1144                    1170                         114      5
## 2           0                     699                          95      1
## 3        1396                    1393                         137      2
## 4         857                     850                          79      7
## 5        2935                    2972                         478     22
##   Grand total exprimé Grand total possible Hommes Inscrits Nuls Total
## 1                4021                 9234      5     1284   40    10
## 2                   0                    0      7      794    0     8
## 3                5792                11637      9     1530   36    11
## 4                4929                 7371     13      929   15    20
## 5               32880                35620     30     3450  120    52
##   Valables Votes par correspondance
## 1     1026                       71
## 2        0                        0
## 3     1293                      109
## 4      819                       57
## 5     2740                      269</code></pre>
<p>Now you can export the table in excel or play with your data in R!</p>
<pre class="r"><code>readr::write_excel_csv(tdf,&quot;election_lux.csv&quot;)
#To know where your file is saved, we use the following function:
#setwd()</code></pre>
<p>I hope you enjoyed reading this post. Don’t hesitate to contact me for any questions. Follow rdata.lu on <a href="https://twitter.com/rdata_lu?lang=en">twitter</a> and subscribe to the <a href="https://www.youtube.com/channel/UCbazvBnJd7CJ4WnTL6BI6qw">youtube channel.</a> See you for the next post ;) <br></p>
<p>Kevin</p>

    </div>
  </div>
</div>

      <footer>
    
    
      
      <div class="container">
        <div class="col-xs-12 col-sm-12 col-md-10 col-lg-10">
          <nav><ul class="pagination pagination-article">
          
              <li class="page-item">
                <a href="/post/2017-10-26-easy-peasy-stata-like-marginal-effect-with-r/" title="Easy peasy STATA-like marginal effects with R " class="page-link">
                  <span aria-hidden="true">&larr;</span>Previous
                </a>
              </li>
          

          
            <li class="page-item">
              <a href="/post/2017-11-14-functional-peace-of-mind/" title="Functional peace of mind" class="page-link">
                  Next <span aria-hidden="true">&rarr;</span>
              </a>
            </li>
          
          </ul> </nav>
        </div>
      </div>

      
    

  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      (function() {
        
        
        if (window.location.hostname == "localhost")
          return;

        var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
        dsq.src = '//wooza.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</footer>

    </div>
      
  </div>
</div>
      <footer class="footer hidden-print">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-md-9">
        <p class="text-xs-center m-a-0 p-a-0">
          &copy; 2017 Copyright &copy; rData.lu. All rights reserved. <br> Content reblogged by <a href='https://www.r-bloggers.com/' target='_blank'>R-bloggers</a>
        </p>
        <p class="text-xs-center  m-a-0 p-a-0">
            
          <span class="p-l-1 p-r-1">
                <a href="/page/disclaimer/"> </a>
              </span>
                
        </p>

      </div>
    </div>
  </div>
</footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.10.8/umd/popper.min.js" integrity="sha256-n96swYoYKdVyLr5XatK9CzcdyrpAI0xcSlIeWOZeTAI=" crossorigin="anonymous"></script>

<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/highlight.pack.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script id="dsq-count-scr" src="//wooza.disqus.com/count.js" async></script>




<script type="text/javascript" src="/assets/js/script.js"></script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-101718661-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


  </body>
</html>

